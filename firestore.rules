/**
 * @file Firestore Security Rules for Sentinel.
 * @description This ruleset enforces a strict separation of public and private data. Public data (hospitals, pharmacies, weather, social media, disease reports, outbreak predictions, alerts) is readable by all users. Private user profile data is accessible only to the owning user and potentially admins (role is not yet implemented).
 * @dataStructure
 * - /hospitals/{hospitalId}: Public data about hospitals.
 * - /pharmacies/{pharmaciesId}: Public data about pharmacies.
 * - /weatherData/{weatherDataId}: Public weather data.
 * - /socialMediaData/{socialMediaDataId}: Public social media data.
 * - /diseaseReports/{diseaseReportId}: Public disease reports.
 * - /outbreakPredictions/{outbreakPredictionId}: Public outbreak predictions.
 * - /alerts/{alertId}: Public alerts.
 * - /userProfiles/{userId}: Private user profile data, only accessible to the owner.
 * @keySecurityDecisions
 * - Public data collections (hospitals, pharmacies, weatherData, socialMediaData, diseaseReports, outbreakPredictions, alerts) are readable by all users, including unauthenticated users.
 * - Listing of user profiles is disallowed for non-owners.
 * - No role-based access control is implemented beyond owner-only access to user profiles.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read hospital data. No write access is granted.
     * @path /hospitals/{hospitalId}
     * @allow (get, list): Any user can read hospital data.
     * @deny (create, update, delete): No one can create, update, or delete hospital data through the client.
     * @principle Public read access for reference data.
     */
    match /hospitals/{hospitalId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read pharmacy data. No write access is granted.
     * @path /pharmacies/{pharmacyId}
     * @allow (get, list): Any user can read pharmacy data.
     * @deny (create, update, delete): No one can create, update, or delete pharmacy data through the client.
     * @principle Public read access for reference data.
     */
    match /pharmacies/{pharmacyId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read weather data. No write access is granted.
     * @path /weatherData/{weatherDataId}
     * @allow (get, list): Any user can read weather data.
     * @deny (create, update, delete): No one can create, update, or delete weather data through the client.
     * @principle Public read access for reference data.
     */
    match /weatherData/{weatherDataId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read social media data. No write access is granted.
     * @path /socialMediaData/{socialMediaDataId}
     * @allow (get, list): Any user can read social media data.
     * @deny (create, update, delete): No one can create, update, or delete social media data through the client.
     * @principle Public read access for reference data.
     */
    match /socialMediaData/{socialMediaDataId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read disease reports. No write access is granted.
     * @path /diseaseReports/{diseaseReportId}
     * @allow (get, list): Any user can read disease reports.
     * @deny (create, update, delete): No one can create, update, or delete disease reports through the client.
     * @principle Public read access for reference data.
     */
    match /diseaseReports/{diseaseReportId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read outbreak predictions. No write access is granted.
     * @path /outbreakPredictions/{outbreakPredictionId}
     * @allow (get, list): Any user can read outbreak predictions.
     * @deny (create, update, delete): No one can create, update, or delete outbreak predictions through the client.
     * @principle Public read access for reference data.
     */
    match /outbreakPredictions/{outbreakPredictionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read alerts. No write access is granted.
     * @path /alerts/{alertId}
     * @allow (get, list): Any user can read alerts.
     * @deny (create, update, delete): No one can create, update, or delete alerts through the client.
     * @principle Public read access for reference data.
     */
    match /alerts/{alertId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to user profile information.  Users can only read/write their own profile data.
     * @path /userProfiles/{userId}
     * @allow (create): A user can create their own profile if the userId matches their auth UID.
     * @allow (get, update, delete): A user can get, update, and delete their own profile if the userId matches their auth UID and the document exists.
     * @deny (create): A user cannot create a profile for another user.
     * @deny (get, update, delete): A user cannot get, update, or delete another user's profile.
     * @deny (list):  Listing of user profiles is not allowed.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /userProfiles/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing user profiles is not allowed.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

     /**
      * @description Checks if the request is made by the owner of the resource and the document exists.
      * @param {string} userId The user ID to compare against the request's auth UID.
      * @return {boolean} True if the user is the owner and the document exists, false otherwise.
      */
    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}