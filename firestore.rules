/**
 * @file Firebase Security Rules for Sentinel App
 * @description This ruleset enforces a strict user-ownership model for personal data while allowing controlled access to symptom reports. Admin privileges are managed through document existence in a dedicated collection.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, accessible only to the user.
 * - /users/{userId}/symptom_reports/{reportId}: Stores user symptom reports, accessible only to the user. The `userId` is denormalized onto each `SymptomReport` document.
 * - /roles_admin/{userId}: Indicates admin privileges; document existence grants admin access.
 * - /symptom_reports_public/{reportId}: Stores anonymized symptom reports for public heatmap visualization.
 *
 * Key Security Decisions:
 * - Users can only access their own user documents and symptom reports.
 * - Admin privileges are granted based on document existence in `/roles_admin/{userId}`.
 * - User listing is disabled for enhanced privacy.
 * - Public symptom reports are readable by any signed-in user but can only be created.
 *
 * Denormalization for Authorization:
 * - The `userId` is denormalized into the `symptom_reports` documents to achieve authorization independence. This avoids costly `get()` calls and ensures efficient security checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) Signed-in user creates their own profile with matching userId.
     * @allow (get, update, delete) Signed-in user accesses their own profile.
     * @deny (create) Signed-in user attempts to create a profile with a mismatched userId.
     * @deny (list) Listing all users is prohibited for privacy reasons.
     * @principle Enforces document ownership for writes and prevents unauthorized data access.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow get, update, delete: if isOwner(userId) && resource.data.id == userId;
      allow list: if false;
    }

    /**
     * @description Manages access to user symptom reports.
     * @path /users/{userId}/symptom_reports/{reportId}
     * @allow (create) Signed-in user creates a symptom report with a matching userId.
     * @allow (get, list, update, delete) Signed-in user accesses their own symptom reports.
     * @deny (create) Signed-in user attempts to create a symptom report for a different user.
     * @principle Enforces document ownership for symptom reports and prevents unauthorized data access.
     */
    match /users/{userId}/symptom_reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow get, list: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Manages admin privileges based on document existence.
     * @path /roles_admin/{userId}
     * @allow (create) Only allow service accounts to create these documents, otherwise it will be open.
     * @allow (get) Signed-in user checks if they have admin privileges.
     * @deny (create, update, delete) Non-admins cannot modify the admin role collection.
     * @deny (list) Listing admins is prohibited.
     * @principle Restricts admin role management to authorized personnel.
     */
    match /roles_admin/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn() && request.auth.uid == userId;
      allow create, update, delete: if false; // Only allow service accounts to manage admin roles
      allow list: if false;
    }

    /**
     * @description Controls access to public symptom reports for heatmap visualization.
     * @path /symptom_reports_public/{reportId}
     * @allow (create) Any signed-in user can create a public symptom report.
     * @allow (list, get) Any signed-in user can read public symptom reports for the heatmap.
     * @deny (update, delete) Public reports are immutable to maintain data integrity.
     */
    match /symptom_reports_public/{reportId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow list, get: if isSignedIn();
        allow update, delete: if false;
    }
  }
}
